name: Backend CI-CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'backend/**'

env:
  IMAGE_NAME: jayaraj0781/resilient-async-job-processing-platform-backend
  VALUES_FILE: helm/resilient-platform/values.yaml
  CHANGELOG: CHANGELOG.md

jobs:
  build:
    runs-on: ubuntu-latest

    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      current_version: ${{ steps.version.outputs.current_version }}
      date_time: ${{ steps.update-changelog.outputs.date_time }}

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract current version from DockerHub or fallback to values.yaml
      id: version
      run: |
        set -e
        DEFAULT_VERSION="0.1.0"

        # Try fetching version from DockerHub
        HUB_VERSION=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.IMAGE_NAME }}/tags/?page_size=100" \
          | jq -r '.results[].name' \
          | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
          | sort -V \
          | tail -n 1 || true)

        if [ -z "$HUB_VERSION" ]; then
          echo "üìÑ DockerHub has no version tags, falling back to reading version from $VALUES_FILE"
          HUB_VERSION=$(yq '.image.tag' "$VALUES_FILE" 2>/dev/null | tr -d '"' || true)
        fi

        if [ -z "$HUB_VERSION" ] || [ "$HUB_VERSION" = "null" ]; then
          echo "‚ö†Ô∏è No version found anywhere. Using default: $DEFAULT_VERSION"
          HUB_VERSION=$DEFAULT_VERSION
        fi

        echo "üîç Current version: v$HUB_VERSION"

        # Split into MAJOR MINOR PATCH
        IFS='.' read -ra PART <<< "$HUB_VERSION"
        MAJOR=${PART[0]:-0}
        MINOR=${PART[1]:-0}
        PATCH=${PART[2]:-0}

        # Increment patch
        PATCH=$((PATCH + 1))

        # Handle semver rollover
        if [ "$PATCH" -gt 9 ]; then
          PATCH=0
          MINOR=$((MINOR + 1))
        fi

        if [ "$MINOR" -gt 9 ]; then
          MINOR=0
          MAJOR=$((MAJOR + 1))
        fi

        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "current_version=$HUB_VERSION" >> $GITHUB_OUTPUT
        echo "üöÄ Bumping version to $NEW_VERSION"
        echo "Trying to login to DockerHub..."

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v3

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and Push Docker Image
      id: docker_build
      uses: docker/build-push-action@v6
      with:
        context: ./backend
        file: ./backend/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        cache-from: type=gha
        cache-to: type=gha,mode=max
        tags: |
          ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.new_version }}
          ${{ env.IMAGE_NAME }}:latest
  
    - name: Echo Build Outputs
      run: |
        echo "Docker image ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.new_version }} built and pushed successfully."
        echo "Image ID: ${{ steps.docker_build.outputs.imageid }}"
        echo "Image digest: ${{ steps.docker_build.outputs.digest }}"
        echo "Metadata: ${{ steps.docker_build.outputs.metadata }}"

    - name: Update Helm Values with new version
      run: |
        yq -i '.image.tag = "${{ steps.version.outputs.new_version }}"' $VALUES_FILE

    - name: Update CHANGELOG
      id: update-changelog
      run: |
        DATE_TIME=$(date +"%Y%m%d%H%M%S")
        VERSION=${{ steps.version.outputs.new_version }}

        if [ ! -f "${CHANGELOG}" ]; then
          echo "Creating initial CHANGELOG.md"
          echo "# CHANGELOG" > ${CHANGELOG}
        fi

        {
          echo "## $VERSION ‚Äî $DATE_TIME"
          echo "- Auto-build by CI-CD pipeline"
          echo "- Updated image to $VERSION"
          echo "- Docker image pushed: ${IMAGE_NAME}:$VERSION"
          echo "- Updated Helm values.yaml with the new tag."
          echo ""
        } >> ${CHANGELOG}

        echo "date_time=$DATE_TIME" >> $GITHUB_OUTPUT

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "Release ${{ steps.version.outputs.new_version }}"
        title: "Release ${{ steps.version.outputs.new_version }}-${{ steps.update-changelog.outputs.date_time }}"
        body: |
          ## Release Summary
          
          **Version:** ${{ steps.version.outputs.new_version }}
          **Build Date:** ${{ steps.update-changelog.outputs.date_time }}
          
          ### Changes
          - Updated image to `${{ steps.version.outputs.new_version }}`
          - Updated Helm values in `${{ env.VALUES_FILE }}`
          - Docker image: `${{ env.IMAGE_NAME }}:${{ steps.version.outputs.new_version }}`
          
          ### Next Steps
          1. Review and merge this PR
          2. Update vales.yml with the new version
          3. Deploy: `helm upgrade --install resilient-platform ./resilient-platform -n resilient-platform`
          
          _Auto-generated by CI/CD pipeline_
        base: main
        labels: 'auto-generated, release'
        branch: release/${{ steps.version.outputs.new_version }}-${{ steps.update-changelog.outputs.date_time }}

    - name: Post-deployment instructions
      run: |
        echo "‚úÖ CI/CD completed successfully."
        echo "üîú Next steps:"
        echo "  üöÄ Update values.yml with the new version"
        echo "  üöÄ Run: helm upgrade --install resilient-platform ./resilient-platform -n resilient-platform"