name: CI-CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'

jobs:

  # ═══════════════════════════════════════════════════════════════════════════
  # BACKEND — triggers on backend/** changes
  # ═══════════════════════════════════════════════════════════════════════════
  backend:
    name: Backend — Build & Release
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(toJson(github.event.commits.*.modified + github.event.commits.*.added + github.event.commits.*.removed), 'backend/')
    steps:
      - uses: actions/checkout@v4

      - name: Build and Release — Backend
        uses: ./.github/actions/build-and-release
        with:
          image_name:   jayaraj0781/resilient-async-job-processing-platform-backend
          context:      ./backend
          dockerfile:   ./backend/Dockerfile
          values_key:   .image.tag
          component:    backend
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token:    ${{ secrets.DOCKERHUB_TOKEN }}


  # ═══════════════════════════════════════════════════════════════════════════
  # FRONTEND — triggers on frontend/** changes
  # ═══════════════════════════════════════════════════════════════════════════
  frontend:
    name: Frontend — Build & Release
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(toJson(github.event.commits.*.modified + github.event.commits.*.added + github.event.commits.*.removed), 'frontend/')
    steps:
      - uses: actions/checkout@v4

      - name: Build and Release — Frontend
        uses: ./.github/actions/build-and-release
        with:
          image_name:   jayaraj0781/resilient-async-job-processing-platform-frontend
          context:      ./frontend
          dockerfile:   ./frontend/Dockerfile
          values_key:   .frontend.image.tag
          component:    frontend
          dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub_token:    ${{ secrets.DOCKERHUB_TOKEN }}
          # Note: NEXT_PUBLIC_BACKEND_API_URL is intentionally NOT passed as a
          # build-arg. It is injected at pod runtime via the Helm ConfigMap,
          # so the same image works across dev / staging / prod without rebuilding.